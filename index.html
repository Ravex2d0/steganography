<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSB UTFâ€‘16</title>
    <style>
      body {
        background: #0b0f14;
        color: #9635ff;
        font-family: monospace;
        padding: 15px;
      }
      textarea, input, select, button {
        background: #111;
        color: #9635ff;
        border: 1px solid #9635ff;
        padding: 6px;
        margin-top: 5px;
      }
      textarea {
        width: 100%;
        height: 90px;
      }
      button {
        cursor: pointer;
      }
      pre {
        background: #050505;
        padding: 10px;
        border: 1px solid #9635ff;
      }
      canvas {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>LSB Steganography</h2>
    <input type="file" id="imageInput"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <textarea id="message" placeholder="Message"></textarea>
    <label>Channel:</label>
    <select id="channel">
      <option value="0">R</option>
      <option value="1">G</option>
      <option value="2">B</option>
    </select>
    <br><br>
    <button onclick="encode()">Encode</button>
    <button onclick="decode()">Decode</button>
    <h3>Decode Result</h3>
    <pre id="result"></pre>
    <canvas id="canvas"></canvas>
    <script>
      function xorEncrypt(bytes, password) {
        const pass = Array.from(password).map(c => c.charCodeAt(0));
        return bytes.map((b, i) => b ^ pass[i % pass.length]);
      }
      
      function utf16ToBytes(str) {
        const bytes = [];
        for (let i = 0; i < str.length; i++) {
          const c = str.charCodeAt(i);
          bytes.push(c >> 8, c & 0xff);
        }
        return bytes;
      }
      
      function bytesToUtf16(bytes) {
        let out = "";
        for (let i = 0; i < bytes.length; i += 2) {
          const c = (bytes[i] << 8) | bytes[i + 1];
          if (c === 0x0000) break;
          out += String.fromCharCode(c);
        }
        return out;
      }
      
      function encode() {
        const file = imageInput.files[0];
        const msg = message.value;
        const pass = password.value;
        const ch = +channel.value;
        
        if (!file || !msg) return alert("Lengkapi input dulu");
        
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const c = canvas;
            const ctx = c.getContext("2d");
            c.width = img.width;
            c.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imgData = ctx.getImageData(0, 0, c.width, c.height);
            const data = imgData.data;
            
            let bytes = utf16ToBytes(msg);
            bytes.push(0x00, 0x00);
            if (pass) bytes = xorEncrypt(bytes, pass);
            
            let bits = bytes.flatMap(b =>
              b.toString(2).padStart(8, "0").split("")
            );
            
            if (bits.length > c.width * c.height) return alert("Pesan kegedean buat gambarnya");
            
            bits.forEach((bit, i) => {
              const idx = i * 4 + ch;
              data[idx] = (data[idx] & 0xFE) | +bit;
            });
            
            ctx.putImageData(imgData, 0, 0);
            
            const a = document.createElement("a");
            a.href = c.toDataURL("image/png");
            a.download = "encoded.png";
            a.click();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      function decode() {
        const file = imageInput.files[0];
        const pass = password.value;
        const ch = +channel.value;
        
        if (!file) return alert("Butuh gambar");
        
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const c = canvas;
            const ctx = c.getContext("2d");
            c.width = img.width;
            c.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const data = ctx.getImageData(0, 0, c.width, c.height).data;
            
            let bits = "";
            for (let i = 0; i < data.length; i += 4) {
              bits += (data[i + ch] & 1);
              if (bits.length % 16 === 0 && bits.slice(-16) === "0000000000000000") break;
            }
            
            let bytes = [];
            for (let i = 0; i < bits.length; i += 8) bytes.push(parseInt(bits.slice(i, i + 8), 2));
            
            if (pass) bytes = xorEncrypt(bytes, pass);
            result.textContent = bytesToUtf16(bytes);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    </script>
  </body>
</html>
